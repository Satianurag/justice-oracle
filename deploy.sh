#!/bin/bash
# Justice Oracle - Production Deployment Script

set -e

echo "ðŸš€ Justice Oracle - Automated Deployment"
echo "========================================"
echo ""

# Check if GenLayer CLI is installed
if ! command -v genlayer &> /dev/null; then
    echo "ðŸ“¦ Installing GenLayer CLI..."
    pip install genlayer-cli
fi

# Check if contract file exists
if [ ! -f "contracts/JusticeOracle.py" ]; then
    echo "âŒ Error: contracts/JusticeOracle.py not found"
    exit 1
fi

echo "âœ… Contract found"
echo ""

# Deploy to GenLayer testnet
echo "ðŸ“¤ Deploying contract to GenLayer testnet..."
echo "   (This uses your local GenLayer node or testnet RPC)"
echo ""

# Deploy using GenLayer CLI
CONTRACT_ADDRESS=$(genlayer deploy contracts/JusticeOracle.py --network testnet --output address)

if [ -z "$CONTRACT_ADDRESS" ]; then
    echo "âŒ Deployment failed"
    exit 1
fi

echo "âœ… Contract deployed successfully!"
echo "ðŸ“ Address: $CONTRACT_ADDRESS"
echo ""

# Update frontend .env.local
echo "âš™ï¸  Configuring frontend..."
cd frontend

cat > .env.local << EOF
# Auto-generated by deploy.sh
# GenLayer testnet configuration

NEXT_PUBLIC_GENLAYER_RPC=https://studio.genlayer.com/api
NEXT_PUBLIC_CONTRACT_ADDRESS=$CONTRACT_ADDRESS
NEXT_PUBLIC_NETWORK=testnet
EOF

echo "âœ… Frontend configured"
echo ""

# Install frontend dependencies if needed
if [ ! -d "node_modules" ]; then
    echo "ðŸ“¦ Installing frontend dependencies..."
    npm install
fi

echo ""
echo "ðŸŽ‰ Deployment Complete!"
echo "========================================"
echo ""
echo "Contract Address: $CONTRACT_ADDRESS"
echo ""
echo "Next steps:"
echo "  1. cd frontend"
echo "  2. npm run dev"
echo "  3. Open http://localhost:3000"
echo ""
echo "ðŸ’° Platform Fees:"
echo "  â€¢ File dispute: 10 tokens (minimum stake)"
echo "  â€¢ Submit evidence: ~1 token (gas)"
echo "  â€¢ Platform fee: 1% of stake"
echo ""
echo "âœ… Contract deployed and ready!"
